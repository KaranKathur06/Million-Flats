datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  USER
  AGENT
  ADMIN
}

enum CountryCode {
  UAE
  India
}

enum PropertySourceType {
  REELLY
  MANUAL
}

enum ManualPropertyStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ManualPropertyMediaCategory {
  COVER
  EXTERIOR
  INTERIOR
  FLOOR_PLANS
  AMENITIES
  BROCHURE
  VIDEO
}

enum ManualPropertyIntent {
  SALE
  RENT
}

enum ManualPropertyConstructionStatus {
  READY
  OFF_PLAN
}

enum ManualModerationAction {
  APPROVE
  REJECT
}

model User {
  id        String   @id @default(uuid())
  role      Role     @default(USER)
  name      String?
  email     String   @unique
  emailVerified DateTime? @map("email_verified")
  image     String?
  password  String?  @map("password_hash")
  googleId  String?  @unique @map("google_id")
  phone     String?
  verified  Boolean  @default(false) @map("is_verified")

  agent Agent?

  accounts Account[]
  sessions Session[]

  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]

  savedProperties SavedProperty[]
  propertyLeads   PropertyLead[]
  preference      UserPreference?

  manualPropertyModerationLogs ManualPropertyModerationLog[] @relation("ManualPropertyModerationAdmin")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("password_reset_tokens")
}

model Agent {
  id       String  @id @default(uuid())
  userId   String  @unique @map("user_id")
  company  String? @map("company_name")
  license  String? @map("license_number")
  whatsapp String? @map("whatsapp_number")
  approved Boolean @default(false)

  bio String? @db.Text
  profileCompletion Int @default(0) @map("profile_completion")
  profileCompletionUpdatedAt DateTime? @map("profile_completion_updated_at")

  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads PropertyLead[]
  listings AgentListing[]
  manualProperties ManualProperty[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("agents")
}

model ManualProperty {
  id          String @id @default(uuid())
  agentId     String @map("agent_id")
  sourceType  PropertySourceType @default(MANUAL) @map("source_type")
  status      ManualPropertyStatus @default(DRAFT)

  title       String?
  propertyType String? @map("property_type")
  intent      ManualPropertyIntent?
  price       Float?
  currency    String @default("AED")
  constructionStatus ManualPropertyConstructionStatus? @map("construction_status")
  shortDescription String? @map("short_description")

  bedrooms   Int @default(0)
  bathrooms  Int @default(0)
  squareFeet Float @default(0) @map("square_feet")

  countryCode CountryCode @default(UAE) @map("country")
  city        String?
  community   String?
  address     String?
  latitude    Float?
  longitude   Float?

  developerName String? @map("developer_name")

  amenities     Json?
  customAmenities Json? @map("custom_amenities")

  paymentPlanText String? @map("payment_plan_text")
  emiNote        String? @map("emi_note")

  authorizedToMarket Boolean @default(false) @map("authorized_to_market")
  exclusiveDeal      Boolean @default(false) @map("exclusive_deal")
  ownerContactOnFile Boolean @default(false) @map("owner_contact_on_file")

  duplicateScore Int? @map("duplicate_score")
  duplicateMatchedProjectId String? @map("duplicate_matched_project_id")
  duplicateOverrideConfirmed Boolean @default(false) @map("duplicate_override_confirmed")

  rejectionReason String? @map("rejection_reason")

  tour3dUrl String? @map("tour_3d_url")

  submittedAt DateTime? @map("submitted_at")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  media ManualPropertyMedia[]
  duplicateOverrideLogs ManualDuplicateOverrideLog[]
  moderationLogs ManualPropertyModerationLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([status])
  @@index([sourceType])
  @@index([countryCode, city])
  @@map("manual_properties")
}

model ManualPropertyModerationLog {
  id         String @id @default(uuid())
  propertyId String @map("property_id")
  adminId    String @map("admin_id")
  action     ManualModerationAction
  reason     String? @db.Text

  property ManualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  admin    User           @relation("ManualPropertyModerationAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([propertyId])
  @@index([adminId])
  @@index([action])
  @@map("manual_property_moderation_logs")
}

model ManualPropertyMedia {
  id        String @id @default(uuid())
  propertyId String @map("property_id")
  category  ManualPropertyMediaCategory
  url       String
  s3Key     String? @map("s3_key")
  mimeType  String? @map("mime_type")
  sizeBytes Int?    @map("size_bytes")
  altText   String? @map("alt_text")
  position  Int @default(0)

  property ManualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([propertyId])
  @@index([category])
  @@map("manual_property_media")
}

model ManualDuplicateOverrideLog {
  id              String @id @default(uuid())
  propertyId      String @map("property_id")
  agentId         String @map("agent_id")
  score           Int
  matchedProjectId String @map("matched_project_id")
  createdAt       DateTime @default(now()) @map("created_at")

  property ManualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([agentId])
  @@map("manual_duplicate_override_logs")
}

model AgentListing {
  id         String      @id @default(uuid())
  agentId    String      @map("agent_id")
  externalId String      @map("external_property_id")
  countryCode CountryCode @default(UAE) @map("country")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([externalId])
  @@index([countryCode])
  @@unique([agentId, externalId])
  @@map("agent_listings")
}

model SavedProperty {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  externalId String      @map("external_property_id")

  countryCode CountryCode @map("country")
  city        String      @map("city")
  community   String?     @map("community")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([externalId])
  @@index([countryCode])
  @@index([countryCode, city])
  @@unique([userId, externalId])
  @@map("saved_properties")
}

model PropertyLead {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  agentId    String   @map("agent_id")
  externalId String   @map("external_property_id")
  message    String?

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([agentId])
  @@index([externalId])
  @@map("property_leads")
}

model UserPreference {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  countryCode CountryCode @map("country")
  city        String?     @map("city")
  community   String?     @map("community")
  filters     Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_preferences")
}

model City {
  id          String      @id @default(uuid())
  countryCode CountryCode @map("country")
  name        String
  communities Community[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([countryCode, name])
  @@index([countryCode])
  @@map("cities")
}

model Community {
  id     String @id @default(uuid())
  cityId String @map("city_id")
  name   String

  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([cityId, name])
  @@index([cityId])
  @@map("communities")
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String
  createdAt DateTime @default(now())
}
