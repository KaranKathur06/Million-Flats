datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  USER
  AGENT
  ADMIN
  SUPERADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum AgentProfileStatus {
  DRAFT
  SUBMITTED
  VERIFIED
  LIVE
  SUSPENDED
}

enum AgentPropertyType {
  RESIDENTIAL
  LUXURY
  COMMERCIAL
}

enum AgentServiceType {
  BUY
  SELL
  RENT
}

enum AgentVerificationDocumentType {
  LICENSE
  ID
}

enum AgentVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CountryCode {
  UAE
  India
}

enum PropertySourceType {
  REELLY
  MANUAL
}

enum ManualPropertyStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

enum ManualPropertyMediaCategory {
  COVER
  EXTERIOR
  INTERIOR
  FLOOR_PLANS
  AMENITIES
  BROCHURE
  VIDEO
}

enum ManualPropertyIntent {
  SALE
  RENT
}

enum ManualPropertyConstructionStatus {
  READY
  OFF_PLAN
}

enum ManualModerationAction {
  APPROVE
  REJECT
}

model User {
  id        String   @id @default(uuid())
  role      Role     @default(USER)
  status    UserStatus @default(ACTIVE)
  name      String?
  email     String   @unique
  emailVerified Boolean  @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  emailVerifiedByAdminId String? @map("email_verified_by_admin_id")
  image     String?
  password  String?  @map("password_hash")
  googleId  String?  @unique @map("google_id")
  phone     String?
  verified  Boolean  @default(false) @map("is_verified")

  agent Agent?

  accounts Account[]
  sessions Session[]

  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]

  savedProperties SavedProperty[]
  propertyLeads   PropertyLead[]
  preference      UserPreference?

  manualPropertyModerationLogs ManualPropertyModerationLog[] @relation("ManualPropertyModerationAdmin")
  auditLogs AuditLog[] @relation("AuditLogPerformedBy")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("email_verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
  @@map("password_reset_tokens")
}

model Agent {
  id       String  @id @default(uuid())
  userId   String  @unique @map("user_id")
  company  String? @map("company_name")
  license  String? @map("license_number")
  whatsapp String? @map("whatsapp_number")
  approved Boolean @default(false)

  profileStatus AgentProfileStatus @default(DRAFT) @map("profile_status")

  bio String? @db.Text
  profileCompletion Int @default(0) @map("profile_completion")
  profileCompletionUpdatedAt DateTime? @map("profile_completion_updated_at")

  user  User @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads PropertyLead[]
  listings AgentListing[]
  manualProperties ManualProperty[]

  serviceAreas AgentServiceArea[]
  specializations AgentSpecialization[]
  metrics AgentMetric?
  badges AgentBadge[]
  verifications AgentVerification[]
  reviews AgentReview[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("agents")
}

model AgentServiceArea {
  id       String @id @default(uuid())
  agentId  String @map("agent_id")
  city     String
  locality String?
  latitude Float?
  longitude Float?

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([city])
  @@unique([agentId, city, locality])
  @@map("agent_service_areas")
}

model AgentSpecialization {
  id           String @id @default(uuid())
  agentId      String @map("agent_id")
  propertyType AgentPropertyType @map("property_type")
  serviceType  AgentServiceType @map("service_type")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([agentId])
  @@index([propertyType])
  @@index([serviceType])
  @@unique([agentId, propertyType, serviceType])
  @@map("agent_specializations")
}

model AgentMetric {
  id               String @id @default(uuid())
  agentId          String @unique @map("agent_id")
  dealsClosed      Int @default(0) @map("deals_closed")
  avgTimeToCloseDays Int? @map("avg_time_to_close_days")
  saleToListRatio  Float? @map("sale_to_list_ratio")
  responseRate     Float? @map("response_rate")
  repeatClientRate Float? @map("repeat_client_rate")
  verixproScore    Int @default(0) @map("verixpro_score")
  lastCalculatedAt DateTime? @map("last_calculated_at")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([verixproScore])
  @@map("agent_metrics")
}

model AgentBadge {
  id       String @id @default(uuid())
  agentId  String @map("agent_id")
  badgeKey String @map("badge_key")
  earnedAt DateTime @default(now()) @map("earned_at")
  revokedAt DateTime? @map("revoked_at")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([badgeKey])
  @@unique([agentId, badgeKey])
  @@map("agent_badges")
}

model AgentVerification {
  id           String @id @default(uuid())
  agentId      String @map("agent_id")
  documentType AgentVerificationDocumentType @map("document_type")
  documentUrl  String @map("document_url")
  status       AgentVerificationStatus @default(PENDING)
  reviewedAt   DateTime? @map("reviewed_at")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([status])
  @@index([documentType])
  @@map("agent_verifications")
}

model AgentReview {
  id            String @id @default(uuid())
  agentId       String @map("agent_id")
  rating        Int
  comment       String? @db.Text
  verifiedDealId String? @map("verified_deal_id")
  createdAt     DateTime @default(now()) @map("created_at")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([rating])
  @@map("agent_reviews")
}

model ManualProperty {
  id          String @id @default(uuid())
  agentId     String @map("agent_id")
  sourceType  PropertySourceType @default(MANUAL) @map("source_type")
  status      ManualPropertyStatus @default(DRAFT)

  lastCompletedStep String? @map("last_completed_step")

  clonedFromId String? @map("cloned_from_id")
  clonedFrom ManualProperty? @relation("ManualPropertyClone", fields: [clonedFromId], references: [id], onDelete: SetNull)
  clones ManualProperty[] @relation("ManualPropertyClone")

  archivedAt DateTime? @map("archived_at")
  archivedBy String? @map("archived_by")

  title       String?
  propertyType String? @map("property_type")
  intent      ManualPropertyIntent?
  price       Float?
  currency    String @default("AED")
  constructionStatus ManualPropertyConstructionStatus? @map("construction_status")
  shortDescription String? @map("short_description")

  bedrooms   Int @default(0)
  bathrooms  Int @default(0)
  squareFeet Float @default(0) @map("square_feet")

  countryCode CountryCode @default(UAE) @map("country")
  city        String?
  community   String?
  address     String?
  latitude    Float?
  longitude   Float?

  developerName String? @map("developer_name")

  amenities     Json?
  customAmenities Json? @map("custom_amenities")

  paymentPlanText String? @map("payment_plan_text")
  emiNote        String? @map("emi_note")

  authorizedToMarket Boolean @default(false) @map("authorized_to_market")
  exclusiveDeal      Boolean @default(false) @map("exclusive_deal")
  ownerContactOnFile Boolean @default(false) @map("owner_contact_on_file")

  duplicateScore Int? @map("duplicate_score")
  duplicateMatchedProjectId String? @map("duplicate_matched_project_id")
  duplicateOverrideConfirmed Boolean @default(false) @map("duplicate_override_confirmed")

  rejectionReason String? @map("rejection_reason")

  tour3dUrl String? @map("tour_3d_url")

  submittedAt DateTime? @map("submitted_at")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  media ManualPropertyMedia[]
  duplicateOverrideLogs ManualDuplicateOverrideLog[]
  moderationLogs ManualPropertyModerationLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([status])
  @@index([sourceType])
  @@index([countryCode, city])
  @@map("manual_properties")
}

enum AuditEntityType {
  MANUAL_PROPERTY
  AGENT
  USER
  ECOSYSTEM_PARTNER_APPLICATION
}

enum AuditAction {
  DRAFT_DELETED
  PUBLISHED_ARCHIVED
  PUBLISHED_CLONED_TO_DRAFT
  ADMIN_APPROVED
  ADMIN_REJECTED
  ADMIN_ARCHIVED
  ADMIN_RESTORED
  ADMIN_CLONED_TO_DRAFT
  ADMIN_AGENT_APPROVED
  ADMIN_AGENT_SUSPENDED
  ADMIN_AGENT_BANNED
  ADMIN_AGENT_ROLE_REVOKED
  ADMIN_AGENT_DELETED
  ADMIN_AGENT_PROFILESTATUS_OVERRIDDEN
  ADMIN_USER_BANNED
  ADMIN_USER_DELETED
  ADMIN_USER_ROLE_CHANGED
  ADMIN_USER_EMAIL_VERIFIED
  USER_EMAIL_VERIFIED
  AGENT_PROFILE_SUBMITTED
  ECOSYSTEM_PARTNER_APPLIED
  ADMIN_ECOSYSTEM_PARTNER_STAGE_CHANGED
}

model AuditLog {
  id         String @id @default(uuid())
  entityType AuditEntityType @map("entity_type")
  entityId   String @map("entity_id")
  action     AuditAction
  performedByUserId String? @map("performed_by_user_id")
  ipAddress  String? @map("ip_address")
  beforeState Json? @map("before_state")
  afterState  Json? @map("after_state")
  meta       Json?

  performedBy User? @relation("AuditLogPerformedBy", fields: [performedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([action])
  @@index([performedByUserId])
  @@map("audit_logs")
}

model ManualPropertyModerationLog {
  id         String @id @default(uuid())
  propertyId String @map("property_id")
  adminId    String @map("admin_id")
  action     ManualModerationAction
  reason     String? @db.Text

  property ManualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  admin    User           @relation("ManualPropertyModerationAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([propertyId])
  @@index([adminId])
  @@index([action])
  @@map("manual_property_moderation_logs")
}

model ManualPropertyMedia {
  id        String @id @default(uuid())
  propertyId String @map("property_id")
  category  ManualPropertyMediaCategory
  url       String
  s3Key     String? @map("s3_key")
  mimeType  String? @map("mime_type")
  sizeBytes Int?    @map("size_bytes")
  altText   String? @map("alt_text")
  position  Int @default(0)

  property ManualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([propertyId])
  @@index([category])
  @@map("manual_property_media")
}

model ManualDuplicateOverrideLog {
  id              String @id @default(uuid())
  propertyId      String @map("property_id")
  agentId         String @map("agent_id")
  score           Int
  matchedProjectId String @map("matched_project_id")
  createdAt       DateTime @default(now()) @map("created_at")

  property ManualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([agentId])
  @@map("manual_duplicate_override_logs")
}

model AgentListing {
  id         String      @id @default(uuid())
  agentId    String      @map("agent_id")
  externalId String      @map("external_property_id")
  countryCode CountryCode @default(UAE) @map("country")

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@index([externalId])
  @@index([countryCode])
  @@unique([agentId, externalId])
  @@map("agent_listings")
}

model SavedProperty {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  externalId String      @map("external_property_id")

  countryCode CountryCode @map("country")
  city        String      @map("city")
  community   String?     @map("community")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([externalId])
  @@index([countryCode])
  @@index([countryCode, city])
  @@unique([userId, externalId])
  @@map("saved_properties")
}

model PropertyLead {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  agentId    String   @map("agent_id")
  externalId String   @map("external_property_id")
  message    String?

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent Agent @relation(fields: [agentId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([agentId])
  @@index([externalId])
  @@map("property_leads")
}

model UserPreference {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  countryCode CountryCode @map("country")
  city        String?     @map("city")
  community   String?     @map("community")
  filters     Json?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_preferences")
}

model City {
  id          String      @id @default(uuid())
  countryCode CountryCode @map("country")
  name        String
  communities Community[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([countryCode, name])
  @@index([countryCode])
  @@map("cities")
}

model Community {
  id     String @id @default(uuid())
  cityId String @map("city_id")
  name   String

  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([cityId, name])
  @@index([cityId])
  @@map("communities")
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String
  createdAt DateTime @default(now())
}

enum EcosystemPartnerApplicationStage {
  APPLIED
  UNDER_REVIEW
  APPROVED
  ONBOARDED
}

model EcosystemPartnerApplication {
  id       String @id @default(cuid())
  category String
  stage    EcosystemPartnerApplicationStage @default(APPLIED)

  companyDetails Json
  contactInfo    Json
  offerDetails   Json?
  businessIntent Json?

  logoUrl        String?
  certificateUrl String?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  referrer    String?
  landingUrl  String?
  userAgent   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([stage])
}
